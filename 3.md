# –°—É–º–º–∞ –¥–≤—É—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤

–ü–µ—Ä–≤–∞—è –∑–∞–¥–∞—á–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è - –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–µ—Ä–≤–æ–º –ø–æ–ø–∞–≤—à–µ–º—Å—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ, –∞ –≤–æ–æ–±—â–µ –Ω–∞ –≤—Å–µ–º, —á—Ç–æ –µ—Å—Ç—å –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.

–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å –∏—Ä–æ–Ω–∏–∏ - —Ç–µ–ø–µ—Ä—å –º—ã —Ö–æ—Ç–∏–º —Å—á–∏—Ç–∞—Ç—å a + b –Ω–µ –¥–≤—É—Ö —á–∏—Å–µ–ª, –∞ –ø–æ—ç–ª–µ–º–µ–Ω—Ç–Ω–æ –≤ –º–∞—Å—Å–∏–≤–µ.

–í–≤–µ–¥—ë–º –Ω–æ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è:

* **Work Item** - —ç—Ç–æ, –ø–æ —Å—É—Ç–∏, —Ç—Ä–µ–¥, –∑–∞–ø—É—Å–∫–∞–µ–º—ã–π –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.
    –ù–∞ –≤–∏–¥–µ–æ–∫–∞—Ä—Ç–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Ç—ã—Å—è—á–∏, –µ—Å–ª–∏ –Ω–µ —Å–æ—Ç–Ω–∏ —Ç—ã—Å—è—á —ç—Ç–∏—Ö —Å–∞–º—ã—Ö —Ç—Ä–µ–¥–æ–≤-Work Item'–æ–≤.

    –ù–∞ –≤–∏–¥–µ–æ–∫–∞—Ä—Ç–µ, –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, –Ω–µ –æ—á–µ–Ω—å –º–Ω–æ–≥–æ —è–¥–µ—Ä –≤ –ø—Ä–∏–≤—ã—á–Ω–æ–º –∏—Ö –ø–æ–Ω–∏–º–∞–Ω–∏–∏. –û–Ω–∏ —É–º–µ—é—Ç —Å—á–∏—Ç–∞—Ç—å, –Ω–æ –Ω–µ —É–ø—Ä–∞–≤–ª—è—Ç—å. –ù–∞–ø—Ä–∏–º–µ—Ä, CUDA-—è–¥—Ä–æ - —Å–∫–æ—Ä–µ–µ –∫–æ–Ω–≤–µ–π–µ—Ä.

    Thread'—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ SIMT (single instruction, multiple threads) (–≤—Å–µ —ç—Ç–∏ thread'—ã –∏—Å–ø–æ–ª–Ω—è—é—Ç –æ–¥–Ω—É –∏ —Ç—É –∂–µ –∫–æ–º–∞–Ω–¥—É).

    –ï—Å–ª–∏ –Ω–∞ –ø—É—Ç–∏ –≤—Å—Ç—Ä–µ—Ç–∏—Ç—Å—è `if` –∏ –æ–Ω–∏ –≤—Å–µ –ø–æ–π–¥—É—Ç –≤ –æ–¥–Ω—É –≤–µ—Ç–∫—É, —Ç–æ –≤—Å–µ —Ö–æ—Ä–æ—à–æ –∏ –æ–Ω–∏ –ø—Ä–æ—Å—Ç–æ —Ç—É–¥–∞ –ø–æ–π–¥—É—Ç.

    –ï—Å–ª–∏ —Ä–∞–∑–Ω—ã–µ thread'—ã –≤ –æ–¥–Ω–æ–º batch (warp'–µ) –ø–æ–π–¥—É—Ç –≤ —Ä–∞–∑–Ω—ã–µ –≤–µ—Ç–∫–∏, —Ç–æ –æ–Ω–∏ –≤—Å–µ –∑–∞–π–¥—É—Ç —Å–Ω–∞—á–∞–ª–∞ –≤ `if`, –Ω–æ —á—Ç–æ-—Ç–æ —Å—á–∏—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ thread'—ã, –∫–æ—Ç–æ—Ä—ã–µ `if` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç. –ü–æ—Ç–æ–º –æ–Ω–∏ –¥—Ä—É–∂–Ω–æ –ø–æ–π–¥—É—Ç –≤ `else` –∏ —Å–¥–µ–ª–∞—é—Ç –Ω–∞–æ–±–æ—Ä–æ—Ç. –ù–æ –∏—Ç–æ–≥ –æ–¥–∏–Ω - —á–∞—Å—Ç—å —Å—á–∏—Ç–∞–µ—Ç, —á–∞—Å—Ç—å –¥–µ–ª–∞–µ—Ç `nop`

* **Warp** (NVIDIA, –°–∫–∞–∫–æ–≤ —á–∞—â–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ) –∏ **Subgroup** (OpenCL —Å—Ç–∞–Ω–¥–∞—Ä—Ç) - batch Work Item'–æ–≤.
    –ò—Ö —Ä–∞–∑–º–µ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–∞–º–∏–º –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è (–µ—Å–ª–∏ –Ω–µ —Å–∫–∞–∑–∞–Ω–æ –æ–± –æ–±—Ä–∞—Ç–Ω–æ–º).

    NVIDIA —Å—Ç–∞—Ä–∞–µ—Ç—Å—è —É–∂–µ –¥–∞–≤–Ω–æ –¥–µ—Ä–∂–∞—Ç—å —ç—Ç–æ —á–∏—Å–ª–æ —Ä–∞–≤–Ω—ã–º 32, –Ω–µ –ø–æ—Ö–æ–∂–µ, —á—Ç–æ –æ–Ω–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è —ç—Ç–æ –º–µ–Ω—è—Ç—å. –£ –Ω–∏—Ö –Ω–∞ —ç—Ç–æ –º–Ω–æ–≥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –∑–∞—Ç–æ—á–µ–Ω–æ.

    AMD –∫–æ–≥–¥–∞-—Ç–æ —Å–æ–≤—Å–µ–º –¥–∞–≤–Ω–æ –±—ã–ª–æ 32, –Ω–æ –¥–∞–≤–Ω–æ —É–∂–µ 64. –ù–∞—á–∏–Ω–∞—è —Å `RDNA2` (`RX6xxx`) —É –Ω–∏—Ö —Å—Ç–∞–ª–æ –≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å –º–µ–∂–¥—É 32 –∏ 64 (–ù–æ –Ω–∞ `CDNA` —Ç–æ–ª—å–∫–æ 64).

    –£ Intel —á–∏—Å–ª–æ –ø–ª–∞–≤–∞—é—â–µ–µ, –≤—Ä–æ–¥–µ –±—ã –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –ø–æ–¥–±–∏—Ä–∞–µ—Ç—Å—è. –ß–µ—Ç –æ—Ç –ø–æ—Ä—è–¥–∫–∞ 4 –¥–æ –ø–æ—Ä—è–¥–∫–∞ 32. –ü–æ –∫—Ä–∞–π–Ω–µ–π –º–µ—Ä–µ, –¥–æ Arc. –ù–∞ Arc –°–∫–∞–∫–æ–≤ –Ω–µ –≤ –∫—É—Ä—Å–µ.

    –£ Intel CPU Runtime –≤—Ä–æ–¥–µ –±—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 32, –Ω–æ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å.

    –ö–∞–∫ –≤–∏–¥–µ–æ–∫–∞—Ä—Ç–∞ –±–æ—Ä–µ—Ç—Å—è —Å –±–æ–ª—å—à–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –æ—Ç–∫–ª–∏–∫–∞ –æ–ø–µ—Ä–∞—Ç–∏–≤–∫–∏? Warp –Ω–µ –±—É–¥–µ—Ç –∂–¥–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–∞–º—è—Ç—å—é, –∞ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö. –ü–æ—ç—Ç–æ–º—É –º—ã —Ö–æ—Ç–∏–º –º–Ω–æ–≥–æ thread'–æ–≤.

* **–õ–æ–∫–∞–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∞**. –õ–æ–∫–∞–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∞, –ø–æ —Å—É—Ç–∏, –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ warp'–æ–≤ –≤ –æ–¥–Ω—É –≥—Ä—É–ø–ø—É —Å –æ–±—â–µ–π –ø–∞–º—è—Ç—å—é.

* –ï—â–µ —Ç—É—Ç –º—ã –≤–≤–µ–¥–µ–º –ø–æ–Ω—è—Ç–∏–µ **–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è**. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å - —è–¥—Ä–æ, –∫–æ—Ç–æ—Ä–æ–µ –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–Ω–≤–µ–π–µ—Ä–æ–≤. 

  –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –æ–¥–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∞ –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ (–ª–æ–∫–∞–ª—å–Ω–∞—è –Ω–µ –¥–µ–ª–∏—Ç—Å—è –Ω–∞ —á–∞—Å—Ç–∏) (–ù–æ –Ω–∞ –æ–¥–Ω–æ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –æ–¥–Ω–æ–π –ª–æ–∫–∞–ª—å–Ω–æ–π –≥—Ä—É–ø–ø—ã).

  –í –æ–¥–∏–Ω –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –æ–¥–Ω–æ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –æ–±—â–µ–º —Å–ª—É—á–∞–µ –æ–¥–∏–Ω warp.


> *—Ç—É—Ç –æ–ø—è—Ç—å —É–Ω–µ—Å–ª–æ –∫—É–¥–∞-—Ç–æ, –ø–æ–º–æ–≥–∏—Ç–µ*

–î–∞–≤–∞–π—Ç–µ —Ç–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞—Ç—å –º–Ω–æ–≥–æ thread'–æ–≤! –î–ª—è —ç—Ç–æ–≥–æ —É –Ω–∞—Å –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

* `global_work_size` - —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –≥–ª–æ–±–∞–ª—å–Ω–æ thread'–æ–≤ –Ω–∞ –Ω–∞—à kernel –≤—ã–¥–µ–ª–∏—Ç—Å—è. –û–Ω–∏ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—Å–µ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.
* `local_work_size` - `global_work_size` –Ω–∞—Ä–µ–∑–∞–µ—Ç—Å—è –Ω–∞ –∫—É—Å–æ—á–∫–∏ (**–ª–æ–∫–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã**) —Ä–∞–∑–º–µ—Ä–æ–º `local_work_size`.

–ò–∑ —ç—Ç–æ–π –≤—Å–µ–π –∫–∞—Ä—Ç–∏–Ω—ã –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è, –¥–æ—Å—Ç—É–ø–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—É - –ª–æ–∫–∞–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∞. –°—Ç–∞–Ω–¥–∞—Ä—Ç, –∫–æ–Ω–µ—á–Ω–æ, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –æ–Ω–∞ —Ä–∞–∑–º–µ—Ä–∞ 1. –ù–æ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –≤–∏–¥–µ–æ–∫–∞—Ä—Ç –±—É–¥—É—Ç –∏–º–µ—Ç—å —Ö–æ—Ç—è –±—ã 256, –∞ –µ—Å–ª–∏ –∏–º–µ–µ—Ç DirectX, —Ç–æ 1024 (–Ω–æ –ê–ú–î, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä—è—á–µ—Ç —ç—Ç–æ, –Ω–∞–¥–æ –Ω–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –µ–µ —É–±–µ–¥–∏—Ç—å —Ä–∞–∑—Ä–µ—à–∏—Ç—å). –í —Ü–µ–ª–æ–º, —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞ >256 —É–∂–µ –Ω–µ –≤—Å–µ–≥–¥–∞ —Å–∏–ª—å–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ. –¢–∞–∫ —á—Ç–æ –µ—Å—Ç—å —Å–º—ã—Å–ª –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω–∞ 256.

–ò–º–µ–µ—Ç —Å–º—ã—Å–ª –¥–µ–ª–∞—Ç—å —Ä–∞–∑–º–µ—Ä –ª–æ–∫–∞–ª—å–Ω–æ–π –≥—Ä—É–ø–ø—ã –∫—Ä–∞—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä—É warp'–∞. (–ï—Å–ª–∏ warp —Ä–∞–∑–º–µ—Ä–∞ 64, –∏ –≤—ã —Å–¥–µ–ª–∞–µ—Ç–µ –≥—Ä—É–ø–ø—É —Ä–∞–∑–º–µ—Ä–∞ 65, —Ç–æ —É –≤–∞—Å –±—É–¥–µ—Ç –æ–¥–∏–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π warp –∏ –æ–¥–∏–Ω warp, –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –Ω–∞ 1/64. –ó–∞—á–µ–º?)

–ö—Å—Ç–∞—Ç–∏:

* `global` –ø–µ—Ä–µ–¥ —É–∫–∞–∑–∞—Ç–µ–ª–µ–º –æ–∑–Ω–∞—á–∞–µ—Ç —Ç–æ, —á—Ç–æ —ç—Ç–æ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞  (–æ–ø–µ—Ä–∞—Ç–∏–≤–∫–∞ —Ç–≤–æ–µ–≥–æ –¥–µ–≤–∞–π—Å–∞)
* `register` - —Ä–µ–≥–∏—Å—Ç—Ä ü§Ø. –ò—Ö –Ω–µ —Ç–æ —á—Ç–æ–±—ã –º–Ω–æ–≥–æ.
* `local`/`shared` - –ª–æ–∫–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å, –∫–æ—Ç–æ—Ä–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º thread'–∞–º –≤–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (–í–Ω—É—Ç—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π –≥—Ä—É–ø–ø—ã –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ warp'–æ–≤). –ï–µ –±–æ–ª—å—à–µ, —á–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤, –Ω–æ –º–µ–Ω—å—à–µ, —á–µ–º –æ–ø–µ—Ä–∞—Ç–∏–≤–∫–∏ (–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç 32–ö–±, NVIDIA –ø–æ–±–æ–ª—å—à–µ, –≤ —Ä–∞–π–æ–Ω–µ 48).

---

–ü–æ—à–ª–∏ —É–ª—É—á—à–∞—Ç—å `a + b` –ø–æ–¥ —Å—É–º–º—É –º–∞—Å—Å–∏–≤–æ–≤!

* –î–∞–≤–∞–π—Ç–µ —É–≤–µ–ª–∏—á–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–¥–µ–ª—è–µ–º–æ–π –ø–∞–º—è—Ç–∏ –≤ –±—É—Ñ–µ—Ä–∞—Ö
* –°–æ–∑–¥–∞–¥–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ thread'–æ–≤, —Ä–∞–≤–Ω–æ–µ —Ä–∞–∑–º–µ—Ä—É –±—É—Ñ–µ—Ä–∞ (`global_work_size`)
* –£ –Ω–∞—Å –Ω–µ—Ç –Ω–∏–∫–∞–∫–æ–≥–æ —Ö–∏—Ç—Ä–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É thread'–∞–º–∏, —Ç–∞–∫ —á—Ç–æ –¥–∞–≤–∞–π—Ç–µ `local_work_size` –≤—Å–µ –µ—â–µ `NULL`
* –ù–µ–º–Ω–æ–≥–æ –ø–æ–¥–ø—Ä–∞–≤–∏–º `.cl` —Ñ–∞–π–ª:

```c
kernel void add(global const int *a, global const int *b, global int *c) {
  size_t x = get_global_id(0); // –ì–æ–≤–æ—Ä–∏—Ç –Ω–æ–º–µ—Ä thread'–∞ –≤–Ω—É—Ç—Ä–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã, 0 - —ç—Ç–æ –Ω–æ–º–µ—Ä –∏–∑–º–µ—Ä–µ–Ω–∏—è (–ø–æ–º–Ω–∏—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç dimensions)?
  c[x] = a[x] + b[x];
}
```

`dimensions`: –ù—É–º–µ—Ä–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–¥–Ω–æ–º–µ—Ä–Ω–∞—è, –¥–≤—É–º–µ—Ä–Ω–∞—è (—Ç–æ–≥–¥–∞ `get_global_id(x, y)`) –∏ —Ç—Ä–µ—Ö–º–µ—Ä–Ω–∞—è (`get_global_id(x, y, z)`).

---

–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ: –¥–æ–≤–µ—Å—Ç–∏ –¥–æ —Ä–∞–±–æ—á–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, —Ç–∞–∫ –µ—â–µ —á—Ç–æ–±—ã –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö —Ä–∞–±–æ—Ç–∞–ª–æ.

---

`aplusb.cl`:

```c
kernel void add(global const int *a, global const int *b, global int *c) {
  size_t x = get_global_id(0); 
  c[x] = a[x] + b[x];
}
```

`main.c`:

```c
#include <stdlib.h>
#ifdef __APPLE__
#include <OpenCL/cl.h>
#else
#include <CL/cl.h>
#endif

#include <assert.h>
#include <stdio.h>

#define EXAMPLE_SIZE 1024

int run_device(cl_device_id device_id);

int run_platform(cl_platform_id platform_id) {
  // –ü–æ–ª—É—á–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
  size_t name_size;
  clGetPlatformInfo(platform_id, CL_PLATFORM_NAME, 0, NULL, &name_size);
  char *name = malloc(name_size + 1);
  clGetPlatformInfo(platform_id, CL_PLATFORM_NAME, name_size, name, NULL);
  name[name_size] = 0;
  printf("==========================\n");
  printf("Running on platform: %s\n", name);
  free(name);

  // –ü–æ–ª—É—á–∏–º —Å–ø–∏—Å–æ–∫ ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  cl_uint device_count;
  clGetDeviceIDs(platform_id, CL_DEVICE_TYPE_ALL, 0, NULL, &device_count);
  printf("%u devices found.\n", device_count);
  cl_device_id *device_ids = malloc(device_count * sizeof(cl_device_id));
  clGetDeviceIDs(platform_id, CL_DEVICE_TYPE_ALL, device_count, device_ids,
                 NULL);

  for (int i = 0; i < device_count; i++) {
    run_device(device_ids[i]);
  }

  free(device_ids);
}

int run_device(cl_device_id device_id) {
  // –ü–æ–ª—É—á–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  size_t name_size;
  clGetDeviceInfo(device_id, CL_DEVICE_NAME, 0, NULL, &name_size);
  char *name = malloc(name_size + 1);
  clGetDeviceInfo(device_id, CL_DEVICE_NAME, name_size, name, NULL);
  name[name_size] = 0;
  printf("--------------------------\n");
  printf("Running on device: %s\n", name);
  free(name);

  // –°–æ–∑–¥–∞–¥–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã
  cl_context context = clCreateContext(NULL, 1, &device_id, NULL, NULL, NULL);

  // –ó–∞–≥—Ä—É–∑–∏–º –ø—Ä–æ–≥—Ä–∞–º–º—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
  FILE *aplusb_file =
      fopen("/home/ildar/documents/uni/6sem/gpu/lec/code/3/aplusb.cl",
            "rb");                 // –û—Ç–∫—Ä–æ–µ–º —Ñ–∞–π–ª
  fseek(aplusb_file, 0, SEEK_END); // –ü–æ—Å—Ç–∞–≤–∏–º —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –∫–æ–Ω–µ—Ü
  size_t aplusb_size = ftell(aplusb_file); // –ó–∞–ø–∏—à–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–æ–Ω—Ü–∞
  fseek(aplusb_file, 0, SEEK_SET); // –í–µ—Ä–Ω–µ–º—Å—è –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞

  char *aplusb_source =
      malloc(aplusb_size + 1); // –í—ã–¥–µ–ª–∏–º –±—É—Ñ–µ—Ä –ø–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
  fread(aplusb_source, aplusb_size, 1, aplusb_file); // –°—á–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
  fclose(aplusb_file);
  aplusb_source[aplusb_size] = 0; // –°—Ç—Ä–æ–∫–∏ –≤ –°–∏ –æ–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è –Ω–∞ –Ω–æ–ª—å!

  cl_program program =
      clCreateProgramWithSource(context, 1, (const char **)&aplusb_source,
                                (const size_t *)&aplusb_size, NULL);

  // –°–∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É
  cl_int build_err = clBuildProgram(program, 1, &device_id, "", NULL, NULL);

  // –ü–æ–ª—É—á–∏–º –ª–æ–≥–∏
  size_t log_size;
  clGetProgramBuildInfo(program, device_id, CL_PROGRAM_BUILD_LOG, 0, NULL,
                        &log_size);
  char *log = malloc(log_size);
  clGetProgramBuildInfo(program, device_id, CL_PROGRAM_BUILD_LOG, log_size, log,
                        NULL);
  printf("Build log:\n%s\n", log);
  free(log);

  // –ü—Ä–æ–≤–µ—Ä–∏–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
  if (build_err != 0) {
    printf("Could not build program! See log for details.\n");
    return -2;
  }

  printf("Built program successfully!\n");

  // –°–æ–∑–¥–∞–¥–∏–º –æ—á–µ—Ä–µ–¥—å –∫–æ–º–∞–Ω–¥
  cl_command_queue command_queue =
      clCreateCommandQueue(context, device_id, 0, NULL);

  // –ü–æ–ª—É—á–∏–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä kernel'–∞
  cl_kernel kernel = clCreateKernel(program, "add", NULL);

  // –í—ã–¥–µ–ª–∏–º –ø–∞–º—è—Ç—å –Ω–∞ –¥–µ–≤–∞–π—Å–µ –∏ –ø–æ—Å—Ç–∞–≤–∏–º –µ–µ –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç—ã kernel'–∞
  cl_mem a_mem = clCreateBuffer(context, CL_MEM_READ_ONLY,
                                sizeof(cl_int) * EXAMPLE_SIZE, NULL, NULL);
  clSetKernelArg(kernel, 0, sizeof(cl_mem), &a_mem);
  cl_mem b_mem = clCreateBuffer(context, CL_MEM_READ_ONLY,
                                sizeof(cl_int) * EXAMPLE_SIZE, NULL, NULL);
  clSetKernelArg(kernel, 1, sizeof(cl_mem), &b_mem);
  cl_mem c_mem = clCreateBuffer(context, CL_MEM_WRITE_ONLY,
                                sizeof(cl_int) * EXAMPLE_SIZE, NULL, NULL);
  clSetKernelArg(kernel, 2, sizeof(cl_mem), &c_mem);

  // –ü–æ—Å—Ç–∞–≤–∏–º –≤ –æ—á–µ—Ä–µ–¥—å –∑–∞–ø–∏—Å—å –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
  cl_int a[EXAMPLE_SIZE];
  cl_int b[EXAMPLE_SIZE];
  for (int i = 0; i < EXAMPLE_SIZE; i++) {
    a[i] = i;
    b[i] = 3 * i;
  }
  clEnqueueWriteBuffer(command_queue, a_mem, CL_FALSE, 0,
                       sizeof(cl_int) * EXAMPLE_SIZE, a, 0, NULL, NULL);
  clEnqueueWriteBuffer(command_queue, b_mem, CL_FALSE, 0,
                       sizeof(cl_int) * EXAMPLE_SIZE, b, 0, NULL, NULL);

  // –ü–æ—Å—Ç–∞–≤–∏–º –≤ –æ—á–µ—Ä–µ–¥—å –∑–∞–ø—É—Å–∫ kernel'–∞
  size_t global_work_size = EXAMPLE_SIZE;
  clEnqueueNDRangeKernel(command_queue, kernel, 1, NULL, &global_work_size,
                         NULL, 0, NULL, NULL);

  // –ü–æ—Å—Ç–∞–≤–∏–º –≤ –æ—á–µ—Ä–µ–¥—å —á—Ç–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ (–≤ –±–ª–æ–∫–∏—Ä—É—é—â–µ–º —Ä–µ–∂–∏–º–µ, —á—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç –Ω–∞—à—É
  // –ø—Ä–æ–≥—Ä–∞–º–º—É)
  cl_int c[EXAMPLE_SIZE];
  clEnqueueReadBuffer(command_queue, c_mem, CL_TRUE, 0,
                      sizeof(cl_int) * EXAMPLE_SIZE, c, 0, NULL, NULL);

  // –ü—Ä–æ–≤–µ—Ä–∏–º
  for (int i = 0; i < EXAMPLE_SIZE; i++) {
    /*printf("Executed %d + %d successfully, got %d (expected %d).\n", a[i], b[i],
           c[i], a[i] + b[i]);*/
    assert(a[i] + b[i] == c[i]);
  }
  printf("Executed a + b successfully.\n");

  // –ü—Ä–∏–±–µ—Ä–µ–º—Å—è –Ω–∞–ø–æ—Å–ª–µ–¥–æ–∫
  clReleaseMemObject(a_mem);
  clReleaseMemObject(b_mem);
  clReleaseMemObject(c_mem);
  clReleaseKernel(kernel);
  clReleaseProgram(program);
  clReleaseCommandQueue(command_queue);
  clReleaseContext(context);
}

int main() {
  // –ü–æ–ª—É—á–∏–º —Å–ø–∏—Å–æ–∫ ID –ø–ª–∞—Ç—Ñ–æ—Ä–º
  cl_uint platform_count;
  clGetPlatformIDs(0, NULL, &platform_count);
  printf("%u platforms found.\n", platform_count);
  cl_platform_id *platform_ids =
      malloc(platform_count * sizeof(cl_platform_id));
  clGetPlatformIDs(platform_count, platform_ids, NULL);

  for (int i = 0; i < platform_count; i++) {
    run_platform(platform_ids[i]);
  }

  free(platform_ids);
  return 0;
}
```
